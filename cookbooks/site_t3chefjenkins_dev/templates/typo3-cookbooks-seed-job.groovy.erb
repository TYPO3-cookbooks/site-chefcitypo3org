def organization = 'TYPO3-cookbooks'
def userType = 'orgs' // 'orgs' or 'users'
def repoFilter = ~/.*/

repoApi = new URL("https://api.github.com/${userType}/${organization}/repos?per_page=100")
repos = new groovy.json.JsonSlurper().parse(repoApi.newReader())

repos.findAll{ r -> r.name =~ repoFilter }.each {

  def repoName = it.name
  def jobBaseName = "cookbook-${repoName}".replaceAll('/','-')
  def branchName = "master"

  workflowJob('cookbook-pipeline-' + jobBaseName) {
    definition {
      cps {
        script(
          // TODO find better way to generate this job (e.g. using a template)!
          "node {\n" +
          "  stage 'clone cookbook'\n" +
          "  git url: 'https://github.com/TYPO3-cookbooks/" + repoName + ".git'\n" +
          "\n" +
          "  stage 'foodcritic'\n" +
          "  sh 'foodcritic . -f all'\n" +
          "\n" +
          "  stage 'berks'\n" +
          "  sh 'berks install'\n" +
          "\n" +
          "  stage 'testkitchen'\n" +
          "  if (fileExists('.kitchen.docker.yml')) {\n" +
          "    echo 'Using the cookbooks .kitchen.docker.yml'\n" +
          "  } else {\n" +
          "    echo 'Placing default .kitchen.docker.yml file in workspace'\n" +
          "    writeFile file: '.kitchen.docker.yml', text: '''driver:\n" +
          "name: docker\n" +
          "use_sudo: false\n" +
          "'''\n" +
          "  }\n" +
          "  // it is okay-ish for us at the current state, if kitchen fails\n" +
          "  catchError {\n" +
          "    withEnv([\"KITCHEN_LOCAL_YAML=.kitchen.docker.yml\"]) {\n" +
          "      sh '[ -f .kitchen.yml ] || exit 0;  kitchen test'\n" +
          "    }\n" +
          "  }\n" +
          "  stage 'upload'\n" +
          "  input 'Do you want to upload?'\n" +
          "  sh 'berks upload'\n" +
          "}"
        )
      }
    }
  }

}
